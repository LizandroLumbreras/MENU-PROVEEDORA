<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resumen de Salida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
  body {
    font-family: Arial, sans-serif;
    background: linear-gradient(to right, #00416A, #E4E5E6);
    color: white;
    padding: 20px;
  }

  .resumen {
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 20px;
    max-width: 800px;
    margin: auto;
  }

  h2 {
    text-align: center;
    margin-bottom: 20px;
  }

  .firmas {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
  }

  .firmas div {
    width: 45%;
    text-align: center;
  }

  .firmas img {
    max-width: 100%;
    height: 100px;
    background: white;
    border-radius: 5px;
  }

  ul {
    list-style: none;
    padding: 0;
    margin: 10px 0;
  }

  li {
    margin-bottom: 10px;
    background: white;
    color: black;
    padding: 10px;
    border-radius: 5px;
  }

  button {
    display: block;
    margin: 30px auto 0;
    padding: 12px 20px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    background: green;
    color: white;
    cursor: pointer;
  }

  /* üñ®Ô∏è Ajustes para impresi√≥n t√©rmica */
  @media print {
    body {
      background: white !important;
      color: black;
      margin: 0;
      padding: 0;
    }

    .resumen {
      width: 280px !important;
      max-width: 100% !important;
      padding: 0;
      margin: 0 auto;
      background: white !important;
      color: black;
    }

    .resumen * {
      color: black !important;
      background: none !important;
    }

    .firmas {
      display: flex;
      justify-content: space-between;
    }

    .firmas div {
      font-size: 10px;
    }

    button,
    .no-print {
      display: none !important;
    }
  }
</style>
</head>
<body>

  <div class="resumen">
    <h2>üìã Resumen de salida</h2>
    <p><strong>Folio:</strong> <span id="folio">Cargando...</span></p>
    <p><strong>Fecha:</strong> <span id="fecha"></span></p>
    <p><strong>Entrega:</strong> <span id="entrega"></span></p>
    <p><strong>Recibe:</strong> <span id="recibe"></span></p>
    <p><strong>Destino:</strong> <span id="destino"></span></p>

    <h3>üõí Art√≠culos:</h3>
    <ul id="lista-articulos"></ul>

    <div class="firmas">
      <div>
        <p>Firma quien entrega</p>
        <img id="firmaEntrega" src="" alt="Firma entrega">
      </div>
      <div>
        <p>Firma quien recibe</p>
        <img id="firmaRecibe" src="" alt="Firma recibe">
      </div>
    </div>

    <button onclick="window.print()">üñ®Ô∏è Imprimir resumen</button>
  </div>

  <button onclick="guardarEnFirebase()" style="background-color: #007bff; color: white; padding: 12px 20px; font-size: 16px; border-radius: 8px; border: none; cursor: pointer; display: block; margin: 30px auto;">
    üíæ Guardar salida
  </button>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.firebasestorage.app",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let folio = "";
    let numeroFolio = 0;

    async function obtenerFolioDesdeFirebase() {
      const ref = db.collection("consecutivos").doc("salidas_zapata");
      const snap = await ref.get();
      if (snap.exists) {
        numeroFolio = snap.data().ultimo || 1;
        folio = "PDDZAP - " + String(numeroFolio).padStart(4, "0");
      } else {
        numeroFolio = 1;
        folio = "PDDZAP - 0001";
      }
      document.getElementById("folio").textContent = folio;
    }

    async function guardarEnFirebase() {
      await obtenerFolioDesdeFirebase(); // Asegura folio actualizado

      const fecha = localStorage.getItem("fecha") || "";
      const entrega = localStorage.getItem("entrega") || "";
      const recibe = localStorage.getItem("recibe") || "";
      const destino = localStorage.getItem("destino") || "";
      const firmaEntrega = localStorage.getItem("firmaEntrega") || "";
      const firmaRecibe = localStorage.getItem("firmaRecibe") || "";
      const articulos = JSON.parse(localStorage.getItem("carrito")) || [];

      const salida = {
        folio,
        fecha,
        entrega,
        recibe,
        destino,
        firmaEntrega,
        firmaRecibe,
        articulos,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection("almacenes").doc("almacen_zapata").collection("salidas").add(salida);

        // üîÅ Incrementa folio en Firebase
        await db.collection("consecutivos").doc("salidas_zapata").update({
          ultimo: firebase.firestore.FieldValue.increment(1)
        });

        window.print(); // Imprimir autom√°ticamente

        // ‚úÖ Limpiar datos temporales
        localStorage.removeItem("carrito");
        localStorage.removeItem("firmaEntrega");
        localStorage.removeItem("firmaRecibe");

        setTimeout(() => {
          alert("‚úÖ Salida guardada e impresa correctamente.");
          window.location.href = "./index.html";
        }, 3000);
      } catch (error) {
        console.error("Error al guardar:", error);
        alert("‚ùå Error al guardar la salida.");
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await obtenerFolioDesdeFirebase();

      document.getElementById('fecha').textContent = localStorage.getItem("resumenFecha") || "Sin fecha";
      document.getElementById('entrega').textContent = localStorage.getItem("resumenEntrega") || "No asignado";
      document.getElementById('recibe').textContent = localStorage.getItem("resumenRecibe") || "No asignado";
      document.getElementById('firmaEntrega').src = localStorage.getItem("firmaEntrega") || "";
      document.getElementById('firmaRecibe').src = localStorage.getItem("firmaRecibe") || "";
      document.getElementById('destino').textContent = localStorage.getItem("destino") || "NO DEFINIDO";

      const lista = JSON.parse(localStorage.getItem("carrito")) || [];
      const ul = document.getElementById("lista-articulos");
      lista.forEach(p => {
        const li = document.createElement("li");
        li.textContent = `‚Ä¢ ${p.cantidad} x ${p.nombre} (C√≥digo: ${p.codigo})`;
        ul.appendChild(li);
      });
    });
  </script>
</body>
</html>
